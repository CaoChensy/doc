# 主题二：信贷评分卡建设

## 1. 信贷模型划分

> 贷前模型

- 客户授信申请能否通过？——过退模型
- 客户风险能否接受？——风险模型
- 客户价值有多高？——价值预测模型
- 客户借款需求有多高？——动支意愿模型
- 客户额度该给多少？——额度模型

**授信额度模型**

- 1999年，中国建设银行，授信额度的计算公式为：
$$
CL = E \times K \times V - D
$$
- $E$ 为除易损耗资产外的客户净资产，即客户目前的有限净资产
- $K$ 为目标杠杆率比，按不同行业进行设置
- $V$ 为客户信用等级所对应的调节系数
- $D$ 为目前客户的全部负债扣除客户对本行的负债


> 贷中模型

贷中风控：行为评分（Behavior Scoring），根据借款人放贷后的行为表现，
预测未来逾期风险。在贷前阶段，我们对借款人的履约行为掌握相对较少，而且是静态的，
引入B卡的目的是为了动态监控放款后的风险变化。B卡一般不需要实时上线，离线T+1计算即可。

- 客户借款申请能否通过？——过退模型
- 客户风险是否升高？——风险模型
- 客户是否有流失倾向？——流失预测模型
- 客户是否有借款需求？——动支意愿模型
- 客户忠诚度有多高？——复借预测模型
- 客户借款后是否会提前还款？——还款预测模型
- 客户在不同利率、额度下借款意愿是否发生变化？——利率/额度敏感模型
- 客户价值有多高？——价值预测模型

```mermaid
graph LR
新增授信客户 --流入--> 存量客户`活跃户,睡眠户,管制户`
存量客户`活跃户,睡眠户,管制户` --流出--> 流失客户
```

存量客户如何经营，平衡风险、借款意愿、流失概率？
- 促交易
- 调额度、调价格
- 交叉销售

**在存量客户经营中，可建立两个维度的模型：**
    1. 借款交易审批。样本定义在借据维度，观察点为借款时点。
    1. 定期跑批监控。样本定义在客户维度，观察点为切片时点。

> 贷后模型

在客户逾期后，我们在关注什么客户哪些维度的行为呢？
1. 客户未来一段时间内是否会还钱？——还款预测模型
1. 客户未来一段时间内是否会失联？——失联预测模型

**催收模型**

风险等级与逾期客户的类型
1. 一级风险：还款意愿和还款能力良好，客户因特殊原因出现逾期。
2. 二级风险：还款意愿良好，还款能力出现问题。
3. 三级风险：无还款意愿或还款意愿恶化，但有还款能力。
4. 四级风险：无还款意愿，还款能力弱化或无还款能力。

**C-M1 模型**
C-M1模型开发的目的在于预测还款日前5天的客户是否会发生逾期，即CPD=1。
对于贷后催收策略设计，主要用于Pre催收，降低违约风险提升还款率。常用的入模变量有：
- 分期期数
- 第一期逾期天数
- 当前一个月正常拆分扣款总次数
- 当前3个月内还款最大金额
- 历史最大逾期天数
- 当前一个月逾期拆分扣款总次数
- 首次成功还款时间距离当前时间
- 当前三个月内尝试提现最低金额

一般C-M1(CPD1)模型的KS要求在0.5以上，AUC在80%以上。
通过对评分模型分数进行风险等级划分，根据风险等级制定不同的催收策略，
比如IVR催收、短信提醒等。

**CPD1-10 模型**

CPD1-10模型开发的目的在于预测处于CPD1阶段的客户在10天内是否会还款，
即预测CPD=1的客户CPD>=10的概率。对于贷后催收策略设计，
主要用于M1阶段精细化催收策略，如IVR、预测式外呼、预览式外呼。
常用的入模变量有：

- TPC的数量
- DBR
- 个人信息（性别、年龄、收入）等
- 近31天通话总次数
- 历史RPC未接通次数
- 本次合同单上是否DPD>=10
- 近15天内通过为0的总次数

其中，TPC表示借款客户提供的联系人信息是否为第三方信息，
BDR=Deat Burden Ratio，代表债务负担比率。
一般CPD1-10模型的KS要求在0.45以上，AUC在0.75以上。
当客户处于CPD=1的状态时，就触发运行CPD1-10模型。

**失联预测模型**

失联预测模型开发的目的在于预测在CPD=10的客户，未来5天后是否会失联。
即在CPD10的客户预测在CPD16时是否会失联。对于贷后催收策略设计，
主要用于失联信息修复和提前委外催收，常用的入模变量有：

- 逾期金额占比
- 居住城市与银行卡城市是否一致
- 联系人RPC的数量
- 近一天本人电话催收次数
- 个人信息（性别、年龄、收入）等
- 是否BP
- 委外标识
- 与客户上次进入失联的时间差
- 最大贷款期数
- 逾期天数

一般失联预测模型的KS要求在0.5以上，AUC在0.8以上。
对失联预测模型高风险的客群，催收策略可以采用一旦超过CPD16
之后就进入委外催收流程。

早期催收模型：逾期60天以内，衡量催收效果完成情况。（逾期两期内为主）
晚期催收模型：逾期90天以上，衡量催收动作有效性。

预测变量：违约概率、损失程度、催收响应

- 违约概率：预测早期逾期客户最终违约的概率。
- 损失程度：预测客户违约后可能还款金额占逾期金额比例。
- 催收响应：预测客户对催收方式响应的概率。

**催收评分规则制定**
1. 对客户所有账户的逾期情况形成整体认识。
   - 经营性贷款、个人经营性贷款、信用卡


> 反欺诈模型

- 客户是否在套现？——套现模型
- 客户是否参与赌博？——赌博模型
- 客户是否被诈骗？——诈骗预警模型

> 画像模型

- 客户职业是什么？——职业标签模型
- 客户收入有多少？——收入预测模型

## 2. 样本

> 在拿到样本时，我们需要做一些前置分析，包括：

1. 首借/复借占比、不同渠道授信/借款占比。
2. 每个月的正样本率变化趋势。

> 可用数据

- 消费、社交、设备、征信、电商、行为、个人、多头

> 特征工程

- 统计维度：金额、次数、天数
- 时间维度：7天、30、60、90、180
- 行为维度：借款、还款（提前、正常、逾期）、登录、注册

借款订单属性：
    - 决策信息：是否通过
    - 借款金额：
        - 绝对值：范围
        - 相对值：占额度的比例
    - 借款期数：1、3、6、9、12
    - 下单时间：
        - 一天的时间分布：0-6、6-12、12-18、18-24
        - 工作日、周末、节假日
        - 日期差：
            - 距离授信日期差
            - 距离近一次借款日期差
            - 距离首次借款日期差
            - 距离未来最近一个还款日期的日期差
    - 借款用途：消费、经营

## 3. 数据质量检查与清洗

覆盖率、均值、分位数、最小值、最大值等

## 4. 特征变量筛选逻辑

变量筛选一般从三种维度来衡量：

1. 与y无关，纯从样本出发，计算变量的稳定性，相关性，共线性等。
1. 与y相关，与模型训练无关。计算变量的区分度、信息量（IV）。
1. 与y相关，与模型训练有关。计算变量的特征重要性、SHAP值等。

在保证模型效果的前提下，我们会尽可能控制入模变量数。这有几个原因:

- 保证模型稳定: 变异系数（CV）、PSI指标
    - 严格来说，当PSI大于0.2时，该特征很不稳定；当PSI在0.1~0.2时，较不稳定；当PSI在0.1以下时，稳定。
- 去除冗余信息:
    - 通常采用AUC、KS、头部抓黑能力、bump point这几项评估指标，以及常会分为20个分箱，观察每个分箱内的坏账率的单调性。
    - 在坏样本量较少时，我们更为推荐AUC指标，因为AUC指标作为一个统计检验量，其方差更低，更加接近于真实值。而KS指标相对更容易波动。
- 便于生产验证:
- 节省数据成本:






## 违约概率

> 信用风险：借款人不能按约定偿还债务的可能性

- 合同性违约：贷款合同，未按约偿还利息及基本金；为按约提供报表，等。
- 技术性违约：企业的资产 < 企业的负债的可能性；莫顿模型。
- 巴赛尔协议规定的违约：
  - 第一还款来源不能全额偿还负债
  - 实质性质债务逾期90天
- 实际操作
  - 按贷款质量分类，贷款分类为不良
  - 本金或利息逾期90天以上

> 莫顿模型

- 基本假设：公司的价值不是正太分布，公司价值的对数服从正太分布。

> 生成环节：采购、生产、销售、收款

> 样本筛选

1. 有一定时期的表现数据，不满足一定表现数据的删除。
1. 违约信息分析：
  1. 观察点正常

## 对公违约概率校准与主标尺开发

> 中心违约趋势测算

- 概念：指资产组合违约概率的长期平均值，同时也是`PD`模型校准应盯住的目标。
- 原则：
  - 审慎性：中心趋势是对资产组合违约概率水平的总体判断，在计算时应重分考虑经济周期因素的影响。
  - 稳定性：确定中心趋势之后，一般不应经常调整。
  - 代表性：中心趋势要能反映资产组合的风险状况。

- 估算方法：

**1. 所有观测年份违约概率的算数平均**

$$
CT = \frac{\sum_{i=1}^{T}PD_i}{T}
$$

**2. 所有观测年份违约概率的几何平均，假设不同年份的违约独立，并推导出一年期违约概率。**

$$
CT = 1 - (\prod_{i=1}^{T}(1-PD_i))^{\frac{1}{T}}
$$

**3. 按照客户数加权平均，对客户数较多的年份赋予较大的权重，解决不同年份违约波动大的问题。**

$$
CT = \sum_{i=1}^{T} \omega_t \frac{D_t}{N_t} \\\\
\omega_t = \frac{N_t}{\sum_{t=1}^T N_t}
$$

$D_t$是该资产组合中第$t$年观察到的违约客户数，$N_t$为第$t$年中该资产敞口中非违约活跃用户的数量。

**4. 按照时间加权平均，权重按时间指数递减**

当前时点为$n$，之前第$i$时点的$P_{n-i}$对应的权重为$(1-\lambda)\lambda^i$。

$$
CT = \sum_t(1-\lambda)\lambda^iP_{n-i}, (0 < \lambda < 1)
$$

在$n$较小时，需对权重做归一化处理，一般$\lambda$取接近$1$的数。

**5. 整体估计**

$$
CT = \frac{\sum_{t = 1}^TD_t}{\sum_{t = 1}^TN_t}
$$

$D_t$是该资产组合中第$t$年观察到的违约客户数，$N_t$为第$t$年中该资产敞口中非违约活跃用户的数量。

**6. 中心趋势调整**

样本量不足，违约数量较少，可利用二项检验的正态近似法，在`90%`的置信水平下，计算违约：

$$
p^* \approx \Phi^{-1} (q) \sqrt{\frac{PD(1-PD)}{n}} + PD
$$

- $\Phi^{-1}$为正态反函数，$q$为`90%`

> 中心趋势校准

$$
样本违约概率： PD_s = \frac{e^{a\times score + b}}{1 + e^{a\times score + b}} \\\\
总体违约概率： PD = \frac{e^{a\times score + b}}{k + e^{a\times score + b}} \\\\
其中：K = \frac{Odds(D_s)}{Odds(D)}
$$

> 主标尺

- 基本原则：
  - 客观：违约概率与等级之间客观对应。
  - 独立：不同机构主标尺可以不同。
  - 统一：全行主标尺尽量统一。
  - 稳定：不宜频繁变动。

- 建设原则：
  - 至少具备7个非违约级，一个违约级别。
  - 风险暴露应在不同债务人级别之间合理分布，不能分布过于集中，某级别客户数量不宜超过`30%`。
  - 能够与外部评级对应，便于同行资产比较。
  - 主标尺应有风险区分能力，不同级别代表不同的违约风险。
  - 各级别客户应尽量分散达到风险区分的目的。
  - 保持主标尺的连续性，各级别PD上下限稳定。

> 主标尺与校准同时操作

对主标尺假设，CT校准，各等级客户分布进行试错，使主标尺同时满足上述三条件。

**Step 1:** 假设资产组合的违约分布特征，Beta分布或正态分布。
**Step 2:** 确定主标尺各等级对应的PD值。
- 每个等级的违约概率的加权平均应该等于整个组合的违约概率：
  $$CT = \sum_{i=1}^N \omega_i PD_i \tag{1}$$
  $$\omega_i 为该等级的客户占比，\sum_{i=1}^N \omega_i = 1$$
- 每个等级的违约概率区间的对数与等级成正比：
  $$Ln(PD) = \alpha Grade + \beta \tag{2}$$
- 令$\bar{PD_i} = PD_i e^{\Delta\beta}$，将$\bar{PD_i}$带入式(1)，式(1)中 \omega_i 为已知量。
- $CT = \sum_{j=1}^M \gamma_jCT_j$，$\gamma$为各子投资组合的资产占比。
- 由 $CT = \sum_{i=1}^N \omega_i \bar{PD_i} = \sum_{i=1}^N \omega_i PD_i e^{\Delta\beta}$，
  可计算$e^{\Delta\beta}$。
- 故$ln\bar{PD} = \alpha Grade + \beta + \Delta\beta$。
  $$\bar{PD} = exp(\alpha Grade + \beta + \Delta\beta) \tag{3}$$
- 式(3)为主标尺PD，$\alpha$越大区分能力越大。
**Step 3:** 确定主标尺各等级对应的违约概率上下限。
- $PD_1^{min} = 0$
- $PD_i^{max} = \frac{ln\bar{PD_i} + ln\bar{PD_{i+1}}}{2}$
- $PD_{i+1}^min = PD_i^{max}$
- $PD_N^{max} = 1$
**Step 4:** 确定各个子组合的模型分值到违约概率的映射关系。
- 原因：不同组合的前5%是不可比较的。需要对各个模型的分数转换为违约概率。

假设$$CT_i = \sum_{i=1}^n\bar{\omega_{ji}} \bar{PD_i},\ j = 1, ..., M$$



## 逻辑回归

* 建立逻辑回归模型
* 对模型进行评分映射

> 逻辑回归表达式

$$
y = \frac{1}{1 + e^{-\theta}} \\\\
\theta = WX + B
$$

> sigmoid函数

$$
sigmoid(x) = \frac{1}{1 + e^{-x}}
$$

> sigmoid函数的导数

$$
\begin{aligned}
\delta sigmoid(x) & = \delta{\frac{1}{1 + e^{-x}}} \\\\
& = \delta{\frac{e^{-x}}{(1 + e^{-x})^2}} \\\\
& = \delta{\frac{1}{1 + e^{-x}} * \frac{e^{-x}}{1 + e^{-x}}} \\\\
& = sigmoid(x) * \frac{1 + e^{-x} - 1}{1 + e^{-x}} \\\\
& = sigmoid(x) * (1 - sigmoid(x))
\end{aligned}
$$

> 损失函数(Cross-entropy, 交叉熵损失函数)

`信息熵:` $-PlogP$(P是概率, 小于1, 取反之后就是正数了),
这个值代表的是信息量, 如果值越大代表对当前情况越不确定, 信息不足.


$$
loss = -\sum{{y_t}log{y_p} + (1 - y_t)log{(1 - y_p)}}
$$

$y_t$: 真实的Y值, 需要进行独热编码

$y_p$: 预测的Y值

> 交叉熵求导

$$
\frac{\delta loss}{\delta Y_p}
= -\frac{\delta Y_tlogY_p}{\delta Y_p}
= \sum_n^N{-\frac{Y_i}{P_i} + \frac{1 - Y_i}{1 - P_i}}
$$

> 准确率计算

`混淆矩阵`

| T\Pre | Positive | Negative |
| :---: | :---: | :---: |
| Positive | TP | FN |
| Negative | FP | TN |

> 评估指标

`召回率计算`

$$
recall = \frac{TP}{TP + FP}
$$

`精准率计算`

$$
precision = \frac{TP}{TP + FN}
$$

### 模型评价
- KS值
- ROC曲线

描绘的是不同的截断点时，并以FPR和TPR为横纵坐标轴，描述随着截断点的变小，TPR随着FPR的变化。
纵轴：TPR=正例分对的概率 = TP/(TP+FN)，其实就是查全率
横轴：FPR=负例分错的概率 = FP/(FP+TN)

作图步骤：

根据学习器的预测结果（注意，是正例的概率值，非0/1变量）对样本进行排序（从大到小）
-----这就是截断点依次选取的顺序
按顺序选取截断点，并计算TPR和FPR---也可以只选取n个截断点，分别在1/n，2/n，3/n等位置
连接所有的点（TPR，FPR）即为ROC图

### KS值

作图步骤：

根据学习器的预测结果（注意，是正例的概率值，非0/1变量）对样本进行排序（从大到小）
-----这就是截断点依次选取的顺序
按顺序选取截断点，并计算TPR和FPR ---也可以只选取n个截断点，分别在1/n，2/n，3/n等位置
横轴为样本的占比百分比（最大100%），纵轴分别为TPR和FPR，可以得到KS曲线
TPR和FPR曲线分隔最开的位置就是最好的”截断点“，最大间隔距离就是KS值，
通常>0.2即可认为模型有比较好偶的预测准确性

> 分数映射

逻辑回归方程

$$
ln\frac{p}{1-p} = w_1x_1 + w_2x_2 + ... + w_nx_n
$$

- 基础分650分
    - 好坏概率为2倍时，加50分
    - 好坏概率为4倍时，加100分
    - 好坏概率为8倍时，加150分

$$
Score = Basic\ Score + PDO\ log_2(\frac{1-p}{p})
$$

**PDO**: Points to Duble the Odds, Odds（好坏比）变为2倍时，所减少的信用分。

示例：

$$
Score = 650 + 50 log_2(\frac{1-p}{p})
$$

> 模型报告

- 系数、截距、变量名称
- 排序好坏捕捉率
- 分数分布、模型(变量)PSI、低分的原因、捕获率、模型KS


---
- [漫谈信贷业务模型体系建设](https://mp.weixin.qq.com/s/i35UcJChh-ChVF0StFYphg)
